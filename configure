#!/bin/bash
CONFIGURE_VERSION=0.0.1
TFOS_VERSION_MAJOR=0
TFOS_VERSION_MINOR=0
TFOS_VERSION_PATCH=3
TFOS_VERSION=$TFOS_VERSION_MAJOR.$TFOS_VERSION_MINOR.$TFOS_VERSION_PATCH
printf "Techflash OS Configure Script v%s starting, built for Techflash OS v%s.%s.%s...\r\n" $CONFIGURE_VERSION $TFOS_VERSION

kernel_done=false
libc_done=false
userspace_done=false
if [ "$1" != "--no-max-screen" ]
then
	if [ "$(tput cols)" -lt 100 ]
	then
		echo "Your terminal is too small. Please resize it to at least 100 columns."
		echo "If you can't (like if you have basic linux console),"
		echo "please run the script with --no-max-screen"
		exit 1
	fi
	if [ "$(tput lines)" -lt 10 ]
	then
		echo "Your terminal is too small. Please resize it to at least 10 lines."
		exit 1
	fi
else
	echo "This option is not supported!!!"
	echo "Be warned.  Things will look weird."
fi
kernel() {
	printf "=====================KERNEL======================\r\n"
	printf "CONFIG_KERN_MAXARGS     Limit in chars of the length of args from GRUB, 100-65535,  (default: 65535): "
	read -r CONFIG_KERN_MAXARGS
	# Check if the value is blank
	if [ -z "$CONFIG_KERN_MAXARGS" ]
	then
		CONFIG_KERN_MAXARGS="65535"
	fi
	# Check if the value is a valid number less than or equal to 65535 and not negative
	if ! [[ "$CONFIG_KERN_MAXARGS" =~ ^[0-9]+$ ]] || [ "$CONFIG_KERN_MAXARGS" -lt 100 ] || [ "$CONFIG_KERN_MAXARGS" -gt 65535 ]
	then
		clear
		echo "Invalid value. Please enter a valid number between 100 and 65535."
		return 1
	fi
	kernel_done=true
	return 0
}
libc() {
	printf "===================LIBC/LIBK=====================\r\n"
	libc_done=true
	return 0
}
userspace() {
	printf "===================USERSPACE=====================\r\n"
	userspace_done=true
	return 0
}

end() {
	printf "Your configuration will be saved in %s/.config\r\n" "$(pwd)"
	cat << EOF > "$(pwd)/.config"
# Config file generated by Techflash OS Configure Script v$CONFIGURE_VERSION
# Made for Techflash OS v$TFOS_VERSION
# !!! DO NOT MANUALLY EDIT THIS FILE !!! USE THE CONFIGURE SCRIPT !!!
###### START AUTOGENERATED CONFIG ######

CONFIGURE_VERSION=$CONFIGURE_VERSION
CONFIG_KERN_VERSION_MAJOR=$TFOS_VERSION_MAJOR
CONFIG_KERN_VERSION_MINOR=$TFOS_VERSION_MINOR
CONFIG_KERN_VERSION_PATCH=$TFOS_VERSION_PATCH
CONFIG_KERN_MAXARGS=$CONFIG_KERN_MAXARGS

####### END AUTOGENERATED CONFIG #######

EOF
}
run() {
	# Run kernel function and check if the return value is 1
	if ! kernel && [ "$kernel_done" != true ]
	then
		run
	else
		if ! libc && [ "$libc_done" != true ]
		then
			run
		else
			if ! userspace && [ "$userspace_done" != true ]
			then
				run
			else
				end
			fi
		fi
	fi
}
run
